<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Quantum Bandit Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet" />
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
      body {
        background-color: #5f5a5a3f;
        color: #e0e0e0;
        font-family: "Segoe UI", sans-serif;
      }
      .card {
        background-color: #fffbfb;
        border: 1px solid #333;
        margin-bottom: 20px;
      }
      .btn-primary {
        background-color: #7000ff;
        border: none;
      }
      .btn-primary:hover {
        background-color: #5a00cc;
      }
      .chart-container {
        min-height: 400px;
      }
      .spinner-border {
        width: 1rem;
        height: 1rem;
        display: none;
      }
      hr {
        border-color: #444;
      }
    </style>
  </head>
  <body>
    <div class="container mt-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1 class="fw-bold">
            <span style="color: #7000ff">Quantum</span> Neural Bandit
          </h1>
          <p class="text-muted">
            Variational Quantum Classifier (VQC) for Market Probability
          </p>
        </div>
        <div>
          <button class="btn btn-primary btn-lg" onclick="runAnalysis()">
            Run QNN Model <span class="spinner-border" id="loading"></span>
          </button>
        </div>
      </div>

      <div class="card p-3 mb-4">
        <label class="mb-2 text-muted small text-uppercase fw-bold"
          >Select Assets</label
        >
        <div>
          {% for t in tickers %}
          <div class="form-check form-check-inline">
            <input
              class="form-check-input ticker-check"
              type="checkbox"
              value="{{t}}"
              id="check-{{t}}"
              checked />
            <label class="form-check-label" for="check-{{t}}">{{t}}</label>
          </div>
          {% endfor %}
        </div>
      </div>

      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">
                Latest Signal Strength (Tomorrow's Prediction)
              </h5>
              <div id="bar-chart" style="height: 400px"></div>
            </div>
          </div>
        </div>
      </div>

      <h4 class="mt-4 mb-3">30-Day Probability Evolution</h4>
      <div class="row" id="line-charts-area"></div>
    </div>

    <script>
      async function runAnalysis() {
        const checkboxes = document.querySelectorAll(".ticker-check:checked");
        const tickers = Array.from(checkboxes).map((cb) => cb.value);

        if (tickers.length === 0) {
          alert("Select a ticker");
          return;
        }

        // UI State: Loading
        document.getElementById("loading").style.display = "inline-block";
        const lineArea = document.getElementById("line-charts-area");
        lineArea.innerHTML = "";

        try {
          const response = await fetch("/api/analyze", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ tickers: tickers }),
          });

          if (!response.ok) {
            throw new Error(`Server returned ${response.status}`);
          }

          const data = await response.json();

          if (data.length === 0) {
            alert("No data received. Check backend console for errors.");
          } else {
            renderBarChart(data);
            renderLineCharts(data);
          }
        } catch (err) {
          console.error(err);
          alert("Error running quantum backend. Check console/terminal.");
        } finally {
          document.getElementById("loading").style.display = "none";
        }
      }

      // 1. Render The Summary Bar Chart
      function renderBarChart(data) {
        const tickers = data.map((d) => d.ticker);
        const qVals = data.map((d) => d.latest.quantum);
        const cVals = data.map((d) => d.latest.classical);

        const trace1 = {
          x: tickers,
          y: cVals,
          name: "Classical Baseline",
          type: "bar",
          marker: { color: "#444" },
        };

        const trace2 = {
          x: tickers,
          y: qVals,
          name: "Quantum QNN",
          type: "bar",
          marker: { color: "#7000ff" },
        };

        const layout = {
          barmode: "group",
          paper_bgcolor: "#1a1a1a",
          plot_bgcolor: "#1a1a1a",
          font: { color: "#ccc" },
          yaxis: { range: [0, 1], title: "Prob(Return > 0)" },
          margin: { t: 30, b: 40 },
        };

        Plotly.newPlot("bar-chart", [trace1, trace2], layout);
      }

      // 2. Render Individual Line Charts (Updated with Prediction & Accuracy)
      function renderLineCharts(data) {
        const container = document.getElementById("line-charts-area");

        data.forEach((item) => {
          const col = document.createElement("div");
          col.className = "col-md-6 mb-4";

          // Color logic:
          // Accuracy: Green if >= 50%, Warning if < 50%
          const accColor =
            item.latest.accuracy >= 50 ? "text-success" : "text-warning";
          // Prediction: Green if > 0.5 (UP), Red if <= 0.5 (DOWN)
          const predBadge =
            item.latest.quantum > 0.5 ? "bg-success" : "bg-danger";

          col.innerHTML = `
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h5 class="card-title fw-bold text-primary mb-0">${item.ticker}</h5>
                                <small class="fw-bold ${accColor}" style="font-size: 0.85em;">
                                    Model Accuracy: ${item.latest.accuracy}%
                                </small>
                            </div>
                            <div class="text-end">
                                <div class="badge bg-secondary mb-1" style="font-size: 0.9em;">
                                    Today: ₹${item.latest.price}
                                </div>
                                <br/>
                                <div class="badge ${predBadge}" style="font-size: 0.9em;">
                                    Tom: ₹${item.latest.predicted_price}
                                </div>
                            </div>
                        </div>
                        <div id="chart-${item.ticker}" style="height: 300px;"></div>
                    </div>
                </div>
            `;
          container.appendChild(col);

          const traceQ = {
            x: item.dates,
            y: item.history.quantum,
            name: "QNN Prob",
            mode: "lines+markers",
            line: { color: "#7000ff", width: 2 },
            marker: { size: 4 },
          };

          const traceC = {
            x: item.dates,
            y: item.history.classical,
            name: "Classical MA",
            mode: "lines",
            line: { color: "#555", dash: "dot" },
          };

          const layout = {
            paper_bgcolor: "#1a1a1a",
            plot_bgcolor: "#1a1a1a",
            font: { color: "#aaa", size: 10 },
            margin: { t: 10, b: 30, l: 30, r: 10 },
            yaxis: { range: [0, 1] },
            showlegend: true,
            legend: { orientation: "h", y: 1.1 },
          };

          Plotly.newPlot(`chart-${item.ticker}`, [traceQ, traceC], layout);
        });
      }
    </script>
  </body>
</html>
